# -----------------------------------------------------------------------------
# 1. RECEIVERS
# -----------------------------------------------------------------------------
receivers:
  # Your existing OTLP receiver for standard OTel clients
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        cors:
          allowed_origins:
            - https://*.slatecast.dev
            - https://*.slatecast.io
            - https://*.slatecast.co
            - https://*.ginkgoo.dev
            - https://*.jasper.dev
          allowed_headers:
            - "*"
          max_age: 7200
        endpoint: 0.0.0.0:4318

  # <-- CORRECTED: Receiver for Vercel's generic JSON webhook
  # This requires the "contrib" version of the OTel Collector
  webhookevent:
    endpoint: 0.0.0.0:8080 # The port for Vercel
    path: /vercel-logs      # A path for the webhook
    # This receiver automatically puts the JSON body into attributes
    # and splits the array into individual logs.

# -----------------------------------------------------------------------------
# 2. EXPORTERS
# -----------------------------------------------------------------------------
exporters:
  prometheus:
    endpoint: "0.0.0.0:8889"

  otlphttp/loki:
    endpoint: "${env:RAILWAY_LOKI_ENDPOINT}" 

  otlp/tempo:
    endpoint: "${env:RAILWAY_TEMPO_ENDPOINT}" 
    tls:
      insecure: true

# -----------------------------------------------------------------------------
# 3. PROCESSORS
# -----------------------------------------------------------------------------
processors:
  batch:

  # This transform processor is still needed to map Vercel's
  # JSON fields to the correct OTel log fields.
  transform/vercel:
    log_statements:
      # Context: The webhookevent receiver puts Vercel's log fields 
      # into the 'attributes' map. We need to move them.
      
      # 1. Set the log body from the Vercel "message" field
      - context: log
        statements:
          - set(body, attributes["message"])
          
      # 2. Set the timestamp (Vercel sends ms, OTLP needs ns)
      - context: log
        statements:
          - set(time_unix_nano, attributes["timestamp"] * 1000000)
          
      # 3. Set the severity
      - context: log
        statements:
          - set(severity_text, attributes["level"])
          
      # 4. Optional: Clean up
      - context: log
        statements:
          - delete_key(attributes, "message")
          - delete_key(attributes, "timestamp")
          - delete_key(attributes, "level")

# -----------------------------------------------------------------------------
# 4. EXTENSIONS
# -----------------------------------------------------------------------------
extensions:
  health_check:
  pprof:
    endpoint: :1888
  zpages:
    endpoint: :55679

# -----------------------------------------------------------------------------
# 5. SERVICE
# -----------------------------------------------------------------------------
service:
  extensions: [pprof, zpages, health_check]
  pipelines:
    traces:
      receivers: [otlp]
      processors: [batch]
      exporters: [otlp/tempo]
    
    metrics:
      receivers: [otlp]
      processors: [batch]
      exporters: [prometheus]
    
    logs:
      # <-- MODIFIED: Using the correct 'webhookevent' receiver
      receivers: [otlp, webhookevent]
      processors: [transform/vercel
