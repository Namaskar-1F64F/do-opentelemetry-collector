# -----------------------------------------------------------------------------
# 1. RECEIVERS
# -----------------------------------------------------------------------------
receivers:
  # Your existing OTLP receiver for standard OTel clients
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        cors:
          allowed_origins:
            - https://*.slatecast.dev
            - https://*.slatecast.io
            - https://*.slatecast.co
            - https://*.ginkgoo.dev
            - https://*.jasper.dev
          allowed_headers:
            - "*"
          max_age: 7200
        endpoint: 0.0.0.0:4318

  # <-- NEW: Receiver for Vercel's generic JSON webhook
  # This requires the "contrib" version of the OTel Collector
  httpjson:
    endpoint: 0.0.0.0:8080 # A new, dedicated port for Vercel

# -----------------------------------------------------------------------------
# 2. EXPORTERS
# -----------------------------------------------------------------------------
exporters:
  # debug:
  #   verbosity: detailed

  # prometheusremotewrite:
  #   endpoint: "${env:RAILWAY_PROMETHEUS_ENDPOINT}" 
  #   tls:
  #     insecure: true

  prometheus:
    endpoint: "0.0.0.0:8889"

  otlphttp/loki:
    endpoint: "${env:RAILWAY_LOKI_ENDPOINT}" 

  otlp/tempo:
    endpoint: "${env:RAILWAY_TEMPO_ENDPOINT}" 
    tls:
      insecure: true

  # zipkin:
  #   endpoint: "${env:RAILWAY_ZINPKIN_ENDPOINT}" 
  #   format: proto

  # otlp/jaeger:
  #   endpoint: "${env:RAILWAY_JAEGER_ENDPOINT}" 
  #   tls:
  #     insecure: true

# -----------------------------------------------------------------------------
# 3. PROCESSORS
# -----------------------------------------------------------------------------
processors:
  batch:

  # <-- NEW: Transform processor to map Vercel's JSON fields to OTel format
  # This also requires the "contrib" version of the OTel Collector
  transform/vercel:
    log_statements:
      # Context: The httpjson receiver puts Vercel's log fields 
      # into the 'attributes' map. We need to move them.
      
      # 1. Set the log body from the Vercel "message" field
      - context: log
        statements:
          - set(body, attributes["message"])
          
      # 2. Set the timestamp (Vercel sends ms, OTLP needs ns)
      - context: log
        statements:
          - set(time_unix_nano, attributes["timestamp"] * 1000000)
          
      # 3. Set the severity
      - context: log
        statements:
          - set(severity_text, attributes["level"])
          
      # 4. Optional: Clean up the attributes we just mapped
      - context: log
        statements:
          - delete_key(attributes, "message")
          - delete_key(attributes, "timestamp")
          - delete_key(attributes, "level")
          # You can keep "id", "deploymentId", "source", "host", "projectId"
          # as attributes, which is good practice.

# -----------------------------------------------------------------------------
# 4. EXTENSIONS
# -----------------------------------------------------------------------------
extensions:
  health_check:
  pprof:
    endpoint: :1888
  zpages:
    endpoint: :55679

# -----------------------------------------------------------------------------
# 5. SERVICE
# -----------------------------------------------------------------------------
service:
  extensions: [pprof, zpages, health_check]
  pipelines:
    traces:
      receivers: [otlp]
      processors: [batch]
      exporters: [otlp/tempo]
    
    metrics:
      receivers: [otlp]
      processors: [batch]
      exporters: [prometheus]
    
    logs:
      # <-- MODIFIED: Add the new receiver and processor
      receivers: [otlp, httpjson]
      processors: [transform/vercel, batch] # Order matters: transform *before* batch
      exporters: [otlphttp/loki]
